import{a as xt}from"./chunk-J5YVJBHZ.js";import{a as vt}from"./chunk-3SOUEDWE.js";import{a as ft}from"./chunk-WP5SVQ3H.js";import{e as O,f as D,g as gt,h as E,i as A,j as V,l as L,n as yt,p as B,q as j}from"./chunk-JRVZ5TRL.js";import{c as nt,e as F,f as ot,g as rt,i as at,k as mt,l as ct,m as st,n as dt,o as lt,s as pt,u as ut}from"./chunk-N72T7JVJ.js";import{f as et,i as it}from"./chunk-3L2WMKXX.js";import{$ as k,Bc as K,Cb as h,Cc as X,Dc as Y,Eb as d,Ec as Z,Gc as tt,Lb as $,Mb as o,Nb as _,Ob as p,Pb as G,Vb as W,Wa as a,Xa as S,Xb as H,Zb as Q,_b as z,a as b,ac as J,b as T,e as u,ea as N,ja as q,kb as x,ob as s,qb as U,ra as v,sa as f,tb as n,ub as i,vb as C,zb as w}from"./chunk-UAJ5BYCW.js";var M=class r{constructor(e){this.firebaseService=e}getCommunicationsByOpportunity(e){return u(this,null,function*(){try{let t=this.firebaseService.getFirestore(),m=D(t,"communications"),c;try{c=E(m,A("opportunityId","==",e),V("date","desc"))}catch(l){console.warn("Index not found, using simple query:",l),c=E(m,A("opportunityId","==",e))}let g=yield L(c),I=[];return g.forEach(l=>{let y=l.data();I.push(b({id:l.id},y))}),I.sort((l,y)=>{let R=l.date?.toDate?l.date.toDate():new Date(l.date);return(y.date?.toDate?y.date.toDate():new Date(y.date)).getTime()-R.getTime()}),I}catch(t){return console.error("Error fetching communications:",t),[]}})}addCommunication(e){return u(this,null,function*(){try{let t=this.firebaseService.getFirestore(),m=D(t,"communications");return(yield B(m,T(b({},e),{createdAt:O.now()}))).id}catch(t){throw console.error("Error adding communication:",t),t}})}static \u0275fac=function(t){return new(t||r)(N(j))};static \u0275prov=k({token:r,factory:r.\u0275fac,providedIn:"root"})};var P=class r{constructor(e){this.firebaseService=e}getActionItemsByOpportunity(e){return u(this,null,function*(){try{let t=this.firebaseService.getFirestore(),m=D(t,"actionItems"),c;try{c=E(m,A("opportunityId","==",e),V("createdAt","desc"))}catch(l){console.warn("Index not found, using simple query:",l),c=E(m,A("opportunityId","==",e))}let g=yield L(c),I=[];return g.forEach(l=>{let y=l.data();I.push(b({id:l.id},y))}),I.sort((l,y)=>{let R=l.createdAt?.toDate?l.createdAt.toDate():new Date(l.createdAt);return(y.createdAt?.toDate?y.createdAt.toDate():new Date(y.createdAt)).getTime()-R.getTime()}),I}catch(t){return console.error("Error fetching action items:",t),[]}})}addActionItem(e){return u(this,null,function*(){try{let t=this.firebaseService.getFirestore(),m=D(t,"actionItems");return(yield B(m,T(b({},e),{isComplete:!1,createdAt:O.now()}))).id}catch(t){throw console.error("Error adding action item:",t),t}})}toggleActionItemComplete(e,t){return u(this,null,function*(){try{let m=this.firebaseService.getFirestore(),c=gt(m,"actionItems",e),g={isComplete:t};t?g.completedAt=O.now():g.completedAt=null,yield yt(c,g)}catch(m){throw console.error("Error updating action item:",m),m}})}static \u0275fac=function(t){return new(t||r)(N(j))};static \u0275prov=k({token:r,factory:r.\u0275fac,providedIn:"root"})};var Ct=r=>["/opportunities",r,"edit"];function Dt(r,e){if(r&1){let t=w();n(0,"div",31)(1,"form",32),h("ngSubmit",function(){v(t);let c=d(2);return f(c.addCommunication())}),n(2,"div",33)(3,"div")(4,"label",34),o(5,"Type"),i(),n(6,"select",35)(7,"option",36),o(8,"Email"),i(),n(9,"option",37),o(10,"Phone Call"),i(),n(11,"option",38),o(12,"WhatsApp"),i(),n(13,"option",39),o(14,"Online Meeting"),i(),n(15,"option",40),o(16,"Physical Meeting"),i()()(),n(17,"div")(18,"label",34),o(19,"Date"),i(),C(20,"input",41),i()(),n(21,"div")(22,"label",34),o(23,"Summary"),i(),C(24,"textarea",42),i(),n(25,"button",43),o(26),i()()()}if(r&2){let t=d(2);a(),s("formGroup",t.communicationForm),a(24),s("disabled",t.communicationForm.invalid||t.communicationLoading),a(),p(" ",t.communicationLoading?"Saving...":"Add Communication"," ")}}function Et(r,e){if(r&1&&(n(0,"div",51)(1,"span",48),o(2),i()()),r&2){let t=d().$implicit;a(2),p("Attachments: ",t.attachments.length,"")}}function At(r,e){if(r&1&&(n(0,"div",44)(1,"div",45)(2,"div",46)(3,"span",47),o(4),i(),n(5,"span",48),o(6),i()()(),n(7,"p",49),o(8),i(),x(9,Et,3,1,"div",50),i()),r&2){let t=e.$implicit,m=d(2);a(4),p(" ",t.type," "),a(2),_(m.getFormattedDate(t.date)),a(2),_(t.summary),a(),s("ngIf",t.attachments&&t.attachments.length>0)}}function Ft(r,e){r&1&&(n(0,"div",52),o(1," No communications logged yet. "),i())}function Ot(r,e){if(r&1){let t=w();n(0,"div",31)(1,"form",32),h("ngSubmit",function(){v(t);let c=d(2);return f(c.addActionItem())}),n(2,"div")(3,"label",34),o(4,"Description"),i(),C(5,"input",53),i(),n(6,"div")(7,"label",34),o(8,"Due Date (Optional)"),i(),C(9,"input",54),i(),n(10,"button",43),o(11),i()()()}if(r&2){let t=d(2);a(),s("formGroup",t.actionItemForm),a(9),s("disabled",t.actionItemForm.invalid||t.actionItemLoading),a(),p(" ",t.actionItemLoading?"Saving...":"Add Action Item"," ")}}function Tt(r,e){if(r&1&&(n(0,"span",48),o(1),i()),r&2){let t=d().$implicit,m=d(2);a(),p(" Due: ",m.getFormattedDate(t.dueDate)," ")}}function kt(r,e){if(r&1&&(n(0,"span",61),o(1),i()),r&2){let t=d().$implicit,m=d(2);a(),p(" Completed: ",m.getFormattedDate(t.completedAt)," ")}}function Nt(r,e){if(r&1){let t=w();n(0,"div",44)(1,"div",55)(2,"input",56),h("change",function(){let c=v(t).$implicit,g=d(2);return f(g.toggleActionItem(c))}),i(),n(3,"div",57)(4,"p",49),o(5),i(),n(6,"div",58),x(7,Tt,2,1,"span",59)(8,kt,2,1,"span",60),i()()()()}if(r&2){let t=e.$implicit;a(2),s("checked",t.isComplete),a(2),U("line-through",t.isComplete),a(),_(t.description),a(2),s("ngIf",t.dueDate),a(),s("ngIf",t.completedAt)}}function Vt(r,e){if(r&1){let t=w();n(0,"div",67)(1,"div",55)(2,"input",56),h("change",function(){let c=v(t).$implicit,g=d(4);return f(g.toggleActionItem(c))}),i(),n(3,"div",57)(4,"p",68),o(5),i(),n(6,"span",61),o(7),i()()()()}if(r&2){let t=e.$implicit,m=d(4);a(2),s("checked",t.isComplete),a(3),_(t.description),a(2),p(" Completed: ",m.getFormattedDate(t.completedAt)," ")}}function Lt(r,e){if(r&1&&(n(0,"div",65),x(1,Vt,8,3,"div",66),i()),r&2){let t=d(3);a(),s("ngForOf",t.completedActionItems)}}function Bt(r,e){if(r&1){let t=w();n(0,"div",62)(1,"button",63),h("click",function(){v(t);let c=d(2);return f(c.showCompletedItems=!c.showCompletedItems)}),o(2),i(),x(3,Lt,2,1,"div",64),i()}if(r&2){let t=d(2);a(2),G(" ",t.showCompletedItems?"Hide":"Show"," Completed Items (",t.completedActionItems.length,") "),a(),s("ngIf",t.showCompletedItems)}}function jt(r,e){r&1&&(n(0,"div",52),o(1," No action items created yet. "),i())}function Mt(r,e){if(r&1){let t=w();n(0,"div")(1,"div",3)(2,"h1",4),o(3,"Opportunity Details"),i(),n(4,"div",5)(5,"a",6),o(6," Edit "),i(),n(7,"a",7),o(8," Back to List "),i()()(),n(9,"div",8)(10,"div",9)(11,"h3",10),o(12),i(),n(13,"p",11),o(14," Opportunity information and details "),i()(),n(15,"div",12)(16,"dl")(17,"div",13)(18,"dt",14),o(19,"Client"),i(),n(20,"dd",15),o(21),i()(),n(22,"div",16)(23,"dt",14),o(24,"Solution"),i(),n(25,"dd",15),o(26),i()(),n(27,"div",13)(28,"dt",14),o(29,"Value"),i(),n(30,"dd",15),o(31),Q(32,"number"),i()(),n(33,"div",16)(34,"dt",14),o(35,"Stage"),i(),n(36,"dd",15)(37,"span",17),o(38),i()()(),n(39,"div",13)(40,"dt",14),o(41,"Probability"),i(),n(42,"dd",15),o(43),i()(),n(44,"div",16)(45,"dt",14),o(46,"Owner"),i(),n(47,"dd",15),o(48),i()(),n(49,"div",13)(50,"dt",14),o(51,"Created"),i(),n(52,"dd",15),o(53),i()(),n(54,"div",16)(55,"dt",14),o(56,"Description"),i(),n(57,"dd",15),o(58),i()()()()(),n(59,"div",18)(60,"div",19)(61,"h2",20),o(62,"Communications"),i(),n(63,"button",21),h("click",function(){v(t);let c=d();return f(c.showCommunicationForm=!c.showCommunicationForm)}),o(64),i()(),n(65,"div",22),o(66),n(67,"button",23),h("click",function(){v(t);let c=d();return f(c.addTestData())}),o(68," Add Test Data "),i()(),x(69,Dt,27,3,"div",24),n(70,"div",25),x(71,At,10,4,"div",26)(72,Ft,2,0,"div",27),i()(),n(73,"div",18)(74,"div",19)(75,"h2",20),o(76,"Action Items"),i(),n(77,"button",28),h("click",function(){v(t);let c=d();return f(c.showActionItemForm=!c.showActionItemForm)}),o(78),i()(),n(79,"div",22),o(80),i(),x(81,Ot,12,3,"div",24),n(82,"div",29),x(83,Nt,9,6,"div",26)(84,Bt,4,3,"div",30)(85,jt,2,0,"div",27),i()()()}if(r&2){let t=d();a(5),s("routerLink",H(24,Ct,t.opportunity.id)),a(7),p(" ",t.opportunity.description," "),a(9),_(t.opportunity.clientName),a(5),_(t.opportunity.solutionName),a(5),p("$",z(32,22,t.opportunity.value),""),a(6),s("ngClass",t.getStageClass(t.opportunity.stage)),a(),p(" ",t.opportunity.stage," "),a(5),p("",t.opportunity.probability,"%"),a(5),_(t.ownerName),a(5),p(" ",t.getFormattedDate(t.opportunity.createdAt)," "),a(5),_(t.opportunity.description),a(6),p(" ",t.showCommunicationForm?"Cancel":"Add Communication"," "),a(2),p(" Debug: Communications array length: ",t.communications.length," "),a(3),s("ngIf",t.showCommunicationForm),a(2),s("ngForOf",t.communications),a(),s("ngIf",t.communications.length===0),a(6),p(" ",t.showActionItemForm?"Cancel":"Add Action Item"," "),a(2),p(" Debug: Action items array length: ",t.actionItems.length," "),a(),s("ngIf",t.showActionItemForm),a(2),s("ngForOf",t.openActionItems),a(),s("ngIf",t.completedActionItems.length>0),a(),s("ngIf",t.actionItems.length===0)}}function Pt(r,e){r&1&&(n(0,"div",69),C(1,"div",70),n(2,"span",71),o(3,"Loading opportunity..."),i()())}var _t=class r{constructor(e,t,m,c,g,I,l){this.route=e;this.opportunityService=t;this.communicationService=m;this.actionItemService=c;this.authService=g;this.userService=I;this.fb=l;this.communicationForm=this.fb.group({type:["Email",F.required],date:[new Date().toISOString().slice(0,16),F.required],summary:["",F.required]}),this.actionItemForm=this.fb.group({description:["",F.required],dueDate:[""]})}getOwnerName(e){return this.usersMap.get(e)?.name||e}opportunity=null;communications=[];actionItems=[];loading=!0;ownerName="";users=[];usersMap=new Map;showCommunicationForm=!1;showActionItemForm=!1;showCompletedItems=!1;communicationLoading=!1;actionItemLoading=!1;communicationForm;actionItemForm;addTestData(){return u(this,null,function*(){if(this.opportunity)try{let e=this.authService.getCurrentUser();yield this.communicationService.addCommunication({opportunityId:this.opportunity.id,type:"Email",date:new Date,summary:"Test communication - discussed project requirements",createdBy:e?.uid||"test-user"}),yield this.actionItemService.addActionItem({opportunityId:this.opportunity.id,description:"Test action item - follow up with client",createdBy:e?.uid||"test-user"}),yield this.loadCommunications(this.opportunity.id),yield this.loadActionItems(this.opportunity.id),console.log("Test data added successfully")}catch(e){console.error("Error adding test data:",e)}})}ngOnInit(){return u(this,null,function*(){let e=this.route.snapshot.paramMap.get("id");if(e&&(yield this.loadOpportunity(e),this.opportunity)){let t=yield this.userService.getUsers();this.users=t,this.usersMap=new Map(t.map(m=>[m.id,m])),this.ownerName=this.getOwnerName(this.opportunity.ownerId),console.log(this.ownerName),yield Promise.all([this.loadCommunications(e),this.loadActionItems(e)])}})}loadOpportunity(e){return u(this,null,function*(){try{console.log("Loading opportunity with ID:",e),this.opportunity=yield this.opportunityService.getOpportunityById(e),console.log("Loaded opportunity:",this.opportunity),this.opportunity||console.error("Opportunity not found with ID:",e)}catch(t){console.error("Error loading opportunity:",t)}finally{this.loading=!1}})}loadCommunications(e){return u(this,null,function*(){try{console.log("Loading communications for opportunity:",e),this.communications=yield this.communicationService.getCommunicationsByOpportunity(e),console.log("Loaded communications:",this.communications)}catch(t){console.error("Error loading communications:",t)}})}loadActionItems(e){return u(this,null,function*(){try{console.log("Loading action items for opportunity:",e),this.actionItems=yield this.actionItemService.getActionItemsByOpportunity(e),console.log("Loaded action items:",this.actionItems)}catch(t){console.error("Error loading action items:",t)}})}addCommunication(){return u(this,null,function*(){if(!(this.communicationForm.invalid||!this.opportunity)){this.communicationLoading=!0;try{let e=this.authService.getCurrentUser(),t=this.communicationForm.value;yield this.communicationService.addCommunication({opportunityId:this.opportunity.id,type:t.type,date:new Date(t.date),summary:t.summary,createdBy:e?.uid||"unknown"}),this.communicationForm.reset({type:"Email",date:new Date().toISOString().slice(0,16),summary:""}),this.showCommunicationForm=!1,yield this.loadCommunications(this.opportunity.id)}catch(e){console.error("Error adding communication:",e)}finally{this.communicationLoading=!1}}})}addActionItem(){return u(this,null,function*(){if(!(this.actionItemForm.invalid||!this.opportunity)){this.actionItemLoading=!0;try{let e=this.authService.getCurrentUser(),t=this.actionItemForm.value,m={opportunityId:this.opportunity.id,description:t.description,createdBy:e?.uid||"unknown"};t.dueDate&&(m.dueDate=new Date(t.dueDate)),yield this.actionItemService.addActionItem(m),this.actionItemForm.reset(),this.showActionItemForm=!1,yield this.loadActionItems(this.opportunity.id)}catch(e){console.error("Error adding action item:",e)}finally{this.actionItemLoading=!1}}})}toggleActionItem(e){return u(this,null,function*(){try{yield this.actionItemService.toggleActionItemComplete(e.id,!e.isComplete),yield this.loadActionItems(this.opportunity.id)}catch(t){console.error("Error toggling action item:",t)}})}get openActionItems(){return this.actionItems.filter(e=>!e.isComplete)}get completedActionItems(){return this.actionItems.filter(e=>e.isComplete)}getFormattedDate(e){if(!e)return"N/A";try{return e.toDate?e.toDate().toLocaleDateString():e instanceof Date?e.toLocaleDateString():new Date(e).toLocaleDateString()}catch{return"Invalid Date"}}getStageClass(e){switch(e){case"Lead":return"bg-gray-100 text-gray-800";case"Qualified":return"bg-blue-100 text-blue-800";case"Proposal":return"bg-yellow-100 text-yellow-800";case"Negotiation":return"bg-orange-100 text-orange-800";case"Awarded":return"bg-green-100 text-green-800";case"Lost":return"bg-red-100 text-red-800";default:return"bg-gray-100 text-gray-800"}}static \u0275fac=function(t){return new(t||r)(S(et),S(vt),S(M),S(P),S(xt),S(ft),S(pt))};static \u0275cmp=q({type:r,selectors:[["app-opportunity-detail"]],standalone:!0,features:[W],decls:4,vars:2,consts:[["loading",""],[1,"p-8","max-w-4xl","mx-auto"],[4,"ngIf","ngIfElse"],[1,"flex","justify-between","items-center","mb-6"],[1,"text-2xl","font-bold"],[1,"space-x-2"],[1,"bg-blue-500","hover:bg-blue-700","text-white","font-bold","py-2","px-4","rounded",3,"routerLink"],["routerLink","/opportunities",1,"bg-gray-500","hover:bg-gray-700","text-white","font-bold","py-2","px-4","rounded"],[1,"bg-white","shadow","overflow-hidden","sm:rounded-lg"],[1,"px-4","py-5","sm:px-6"],[1,"text-lg","leading-6","font-medium","text-gray-900"],[1,"mt-1","max-w-2xl","text-sm","text-gray-500"],[1,"border-t","border-gray-200"],[1,"bg-gray-50","px-4","py-5","sm:grid","sm:grid-cols-3","sm:gap-4","sm:px-6"],[1,"text-sm","font-medium","text-gray-500"],[1,"mt-1","text-sm","text-gray-900","sm:mt-0","sm:col-span-2"],[1,"bg-white","px-4","py-5","sm:grid","sm:grid-cols-3","sm:gap-4","sm:px-6"],[1,"inline-flex","items-center","px-2.5","py-0.5","rounded-full","text-xs","font-medium",3,"ngClass"],[1,"mt-8"],[1,"flex","justify-between","items-center","mb-4"],[1,"text-xl","font-bold"],[1,"bg-blue-500","hover:bg-blue-700","text-white","font-bold","py-2","px-4","rounded","text-sm",3,"click"],[1,"bg-yellow-50","p-2","mb-4","text-sm","text-gray-600"],[1,"ml-4","bg-purple-500","text-white","px-2","py-1","rounded","text-xs",3,"click"],["class","bg-gray-50 p-4 rounded mb-4",4,"ngIf"],[1,"space-y-4"],["class","bg-white border rounded-lg p-4",4,"ngFor","ngForOf"],["class","text-gray-500 text-center py-4",4,"ngIf"],[1,"bg-green-500","hover:bg-green-700","text-white","font-bold","py-2","px-4","rounded","text-sm",3,"click"],[1,"space-y-2"],["class","mt-4",4,"ngIf"],[1,"bg-gray-50","p-4","rounded","mb-4"],[1,"space-y-4",3,"ngSubmit","formGroup"],[1,"grid","grid-cols-1","md:grid-cols-2","gap-4"],[1,"block","text-sm","font-medium","text-gray-700"],["formControlName","type",1,"mt-1","block","w-full","rounded-md","border-gray-300","shadow-sm"],["value","Email"],["value","Phone Call"],["value","WhatsApp"],["value","Online Meeting"],["value","Physical Meeting"],["type","datetime-local","formControlName","date",1,"mt-1","block","w-full","rounded-md","border-gray-300","shadow-sm"],["formControlName","summary","rows","3",1,"mt-1","block","w-full","rounded-md","border-gray-300","shadow-sm"],["type","submit",1,"bg-green-500","hover:bg-green-700","disabled:bg-gray-400","text-white","font-bold","py-2","px-4","rounded",3,"disabled"],[1,"bg-white","border","rounded-lg","p-4"],[1,"flex","justify-between","items-start","mb-2"],[1,"flex","items-center","space-x-2"],[1,"inline-flex","items-center","px-2.5","py-0.5","rounded-full","text-xs","font-medium","bg-blue-100","text-blue-800"],[1,"text-sm","text-gray-500"],[1,"text-gray-900"],["class","mt-2",4,"ngIf"],[1,"mt-2"],[1,"text-gray-500","text-center","py-4"],["type","text","formControlName","description",1,"mt-1","block","w-full","rounded-md","border-gray-300","shadow-sm"],["type","date","formControlName","dueDate",1,"mt-1","block","w-full","rounded-md","border-gray-300","shadow-sm"],[1,"flex","items-start","space-x-3"],["type","checkbox",1,"mt-1","h-4","w-4","text-blue-600","focus:ring-blue-500","border-gray-300","rounded",3,"change","checked"],[1,"flex-1"],[1,"flex","items-center","space-x-4","mt-1"],["class","text-sm text-gray-500",4,"ngIf"],["class","text-sm text-green-600",4,"ngIf"],[1,"text-sm","text-green-600"],[1,"mt-4"],[1,"text-sm","text-gray-600","hover:text-gray-800",3,"click"],["class","mt-2 space-y-2",4,"ngIf"],[1,"mt-2","space-y-2"],["class","bg-gray-50 border rounded-lg p-4",4,"ngFor","ngForOf"],[1,"bg-gray-50","border","rounded-lg","p-4"],[1,"text-gray-600","line-through"],[1,"flex","justify-center","items-center","h-64"],[1,"animate-spin","rounded-full","h-8","w-8","border-b-2","border-blue-500"],[1,"ml-2","text-gray-600"]],template:function(t,m){if(t&1&&(n(0,"div",1),x(1,Mt,86,26,"div",2)(2,Pt,4,0,"ng-template",null,0,J),i()),t&2){let c=$(3);a(),s("ngIf",m.opportunity)("ngIfElse",c)}},dependencies:[tt,K,X,Y,Z,it,ut,at,dt,lt,nt,st,ot,rt,mt,ct],encapsulation:2})};export{_t as OpportunityDetailComponent};
